<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>√âtat des lieux</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@latest/lib/msal-browser.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    /* Styles pour l'impression et le PDF */
    @media print {
      .no-print { display: none !important; }
      
      /* R√©p√©ter les en-t√™tes de tableau sur chaque page */
      thead { display: table-header-group !important; }
      tfoot { display: table-footer-group !important; }
      
      /* √âviter les coupures dans les lignes */
      tr { page-break-inside: avoid !important; break-inside: avoid !important; }
      
      /* Forcer les sauts de page */
      .page-break-before { page-break-before: always !important; break-before: page !important; }
      
      /* Bloc signatures toujours ensemble */
      .signatures-block { page-break-inside: avoid !important; break-inside: avoid !important; }
    }
    
    /* Pour html2pdf.js - styles inline ne suffisent pas toujours */
    #print-content thead { display: table-header-group; }
    #print-content tr { page-break-inside: avoid; break-inside: avoid; }
    #print-content .signatures-block { page-break-inside: avoid; break-inside: avoid; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    /* ===================== Microsoft login (MSAL) ===================== */
    /* Renseigne ces 2 valeurs */
    const MS_TENANT_ID = "eb304221-7dc4-4c7f-a5e5-31d6ca8f13fa";   // ex: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" ou "common"
    const MS_CLIENT_ID = "77bd8b26-52dd-4cfb-adbd-61b003da8157";   // ex: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    
    const msalConfig = {
    auth: {
      authority: `https://login.microsoftonline.com/${MS_TENANT_ID}`,
      clientId: MS_CLIENT_ID,
      redirectUri: window.location.origin + window.location.pathname,
    },
  cache: {
    cacheLocation: "localStorage",
    storeAuthStateInCookie: false,
  },
};

const loginRequest = {
  scopes: ["User.Read", "Files.ReadWrite"], // Pas besoin d'admin
};

const msalInstance = new msal.PublicClientApplication(msalConfig);

async function getAccessToken() {
  const accounts = msalInstance.getAllAccounts();
  if (!accounts.length) {
    await msalInstance.loginPopup(loginRequest);
  }
  const account = msalInstance.getAllAccounts()[0];
  const res = await msalInstance.acquireTokenSilent({ ...loginRequest, account });
  return res.accessToken;
}

/* ===================== Utils nommage / slug ===================== */
const slug = (s) =>
  (s || "")
    .toString()
    .trim()
    .normalize("NFD")              // enl√®ve accents
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "_")
    .replace(/[^\w\-]+/g, "")
    .replace(/_+/g, "_");

const buildEdlName = (info) => {
  const adresse   = slug(info.adresse || "Adresse");
  const locataire = slug(info.locataire || "Locataire");
  const date      = info.date || new Date().toISOString().slice(0, 10);
  const type      = info.type === "entree" ? "ENTREE" : "SORTIE";
  return `${adresse}-${locataire}-${date}-${type}`;
};

/* ===================== OneDrive helpers (dossier = Maintenance) ===================== */
const BASE_FOLDER = "Maintenance";

async function graphJson(path) {
  const token = await getAccessToken();
  const res = await fetch(`https://graph.microsoft.com/v1.0${path}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const txt = await res.text();
  if (!res.ok) throw new Error(`Graph ${res.status}: ${txt}`);
  return txt ? JSON.parse(txt) : {};
}

async function getDriveItemIdByPath(path) {
  // Exemple path: "Maintenance"
  const data = await graphJson(`/me/drive/root:/${encodeURI(path)}`);
  return data.id;
}

async function listChildrenById(itemId) {
  const data = await graphJson(`/me/drive/items/${itemId}/children`);
  return data.value || [];
}


async function listOneDriveChildren(path) {
  const token = await getAccessToken();
  const res = await fetch(
    `https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURI(path)}:/children`,
    { headers: { Authorization: `Bearer ${token}` } }
  );
  if (!res.ok) throw new Error("Liste OneDrive √©chou√©e");
  const data = await res.json();
  return data.value || [];
}

async function listOneDriveFolders(path) {
  const items = await listOneDriveChildren(path);
  return items.filter((i) => i.folder); // only folders
}

async function createOneDriveFolder(parentPath, folderName) {
  const token = await getAccessToken();
  const res = await fetch(
    `https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURI(parentPath)}:/children`,
    {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        name: folderName,
        folder: {},
        "@microsoft.graph.conflictBehavior": "fail",
      }),
    }
  );
  if (!res.ok) throw new Error("Cr√©ation dossier √©chou√©e");
  return res.json();
}

async function ensureFolderPath(path) {
  // Cr√©e les dossiers du chemin progressivement (ex: Maintenance/A/B)
  const parts = path.split("/").filter(Boolean);
  let cur = parts[0]; // "Maintenance" doit d√©j√† exister (dans ton cas oui)
  for (let i = 1; i < parts.length; i++) {
    const next = parts[i];
    const children = await listOneDriveChildren(cur);
    const exists = children.find((x) => x.folder && x.name === next);
    if (!exists) {
      await createOneDriveFolder(cur, next);
    }
    cur = `${cur}/${next}`;
  }
  return cur;
}

async function uploadTextToOneDrive(path, filename, textContent) {
  const token = await getAccessToken();
  const fullPath = `${path}/${filename}`.replace(/\/+/g, "/");

  const res = await fetch(
    `https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURI(fullPath)}:/content`,
    {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: textContent,
    }
  );

  if (!res.ok) {
    const t = await res.text();
    throw new Error("Upload √©chou√©: " + t);
  }
  return res.json();
}

async function downloadOneDriveText(filePath) {
  const token = await getAccessToken();
  const res = await fetch(
    `https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURI(filePath)}:/content`,
    { headers: { Authorization: `Bearer ${token}` } }
  );
  if (!res.ok) throw new Error("Download √©chou√©");
  return res.text();
}


    const Icon = ({ name, size = 20, className = "" }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && lucide[name]) {
          ref.current.innerHTML = '';
          const svg = lucide.createElement(lucide[name]);
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          if (className) svg.setAttribute('class', className);
          ref.current.appendChild(svg);
        }
      }, [name, size, className]);
      return <span ref={ref} className="inline-flex items-center justify-center" />;
    };

    const ETAT_OPTIONS = ['Bon', 'Appropri√©', 'Mauvais', 'Sans objet'];
    const OUI_NON = ['Oui', 'Non'];

    const defaultTemplate = {
      nom: 'Appartement standard',
      pieces: {
        entree: {
          nom: 'Entr√©e', ordre: 1,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'portes', nom: 'Porte(s)' },
            { id: 'serrures', nom: 'Serrures et quincailleries' },
            { id: 'interrupteurs', nom: 'Interrupteurs et prises' },
            { id: 'luminaires', nom: 'Luminaires' },
            { id: 'radiateurs', nom: 'radiateurs' },
          ],
          inventaire: [
            { id: 'detecteur', nom: 'D√©tecteur de fum√©e', qte: 1 },
            { id: 'interphone', nom: 'Interphone', qte: 1 },
          ],
        },
        salon: {
          nom: 'Salon', ordre: 2,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'fenetre', nom: 'Fen√™tre - volet' },
            { id: 'portes', nom: 'Porte(s)' },
            { id: 'interrupteurs', nom: 'Interrupteurs et prises' },
            { id: 'luminaires', nom: 'Luminaires' },
            { id: 'radiateurs', nom: 'radiateurs' },
          ],
          inventaire: [
            { id: 'table_manger', nom: 'Table √† manger', qte: 1 },
            { id: 'chaises', nom: 'Chaises', qte: 4 },
            { id: 'table_basse', nom: 'Table basse', qte: 1 },
            { id: 'canape', nom: 'Canap√©', qte: 1 },
            { id: 'meuble_tv', nom: 'Meuble TV', qte: 1 },
          ],
        },
        cuisine: {
          nom: 'Cuisine', ordre: 3,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'fenetre', nom: 'Fen√™tre - volet' },
            { id: 'portes', nom: 'Porte(s)' },
            { id: 'luminaires', nom: 'Luminaire(s)' },
            { id: 'plan_travail', nom: 'Plan de travail' },
            { id: 'meubles', nom: 'Meubles de cuisine' },
            { id: 'four', nom: 'Four de cuisson' },
            { id: 'plaques', nom: 'Plaques de cuisson' },
            { id: 'hotte', nom: 'Hotte' },
            { id: 'frigo', nom: 'R√©frig√©rateur' },
            { id: 'evier', nom: '√âvier' },
            { id: 'robinet', nom: 'Robinet' },
            { id: 'radiateurs', nom: 'radiateurs' },
          ],
          inventaire: [
            { id: 'micro_onde', nom: 'Micro-onde', qte: 1 },
          ],
        },
        salle_bain: {
          nom: 'Salle de bain', ordre: 4,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'portes', nom: 'Porte(s)' },
            { id: 'luminaires', nom: 'Luminaire(s)' },
            { id: 'douche', nom: 'Douche / Baignoire' },
            { id: 'meuble', nom: 'Meuble de SdB' },
            { id: 'lavabo', nom: 'Lavabo' },
            { id: 'radiateurs', nom: 'radiateurs' },
          ],
          inventaire: [
            { id: 'seche_linge', nom: 'S√®che-linge', qte: 1 },
          ],
        },
        wc: {
          nom: 'WC', ordre: 5,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'portes', nom: 'Porte(s)' },
            { id: 'luminaires', nom: 'Luminaire(s)' },
            { id: 'wc', nom: 'WC' },
          ],
          inventaire: [
          ],
        },
        chambre: {
          nom: 'Chambre', ordre: 6,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'fenetre', nom: 'Fen√™tre - volet' },
            { id: 'portes', nom: 'Porte(s)' },
            { id: 'luminaires', nom: 'Luminaire(s)' },
            { id: 'interrupteurs', nom: 'Interrupteurs et prises' },
            { id: 'radiateurs', nom: 'radiateurs' },
          ],
          inventaire: [
            { id: 'lit', nom: 'Lit', qte: 1 },
            { id: 'matelas', nom: 'Matelas', qte: 1 },
            { id: 'couette', nom: 'Couette', qte: 1 },
            { id: 'bureau', nom: 'Bureau', qte: 1 },
            { id: 'chaise', nom: 'Chaise', qte: 1 },
            { id: 'armoire', nom: 'Armoire', qte: 1 },
          ],
        },
        chauffage: {
          nom: 'Chauffage / Eau chaude', ordre: 7,
          etatLieux: [
            { id: 'chaudiere', nom: 'Chaudi√®re' },
            { id: 'ballon', nom: 'Ballon eau chaude' },
          ],
          inventaire: [],
        },
      },
      cles: [
        { id: 'badge', nom: 'Badge immeuble', qte: 1 },
        { id: 'appartement', nom: 'Cl√© appartement', qte: 2 },
        { id: 'boite_lettres', nom: 'Cl√© bo√Æte aux lettres', qte: 1 },
      ],
    };

    const templateToData = (template, type = 'sortie') => {
      const pieces = {};
      Object.entries(template.pieces).forEach(([key, piece]) => {
        pieces[key] = {
          nom: piece.nom, ordre: piece.ordre || 0,
          etatLieux: piece.etatLieux.map(item => ({ ...item, etat: '', commentaire: '', photos: [] })),
          inventaire: piece.inventaire.map(item => ({ ...item, etat: '', commentaire: '', photos: [] })),
        };
      });
      return {
        info: { type, proprietaire: '', locataire: '', date: new Date().toISOString().split('T')[0], adresse: '', appartement: template.nom },
        pieces,
        cles: template.cles.map(cle => ({ ...cle, rendue: '', commentaire: '', photos: [] })),
        signatures: { locataire: '', proprietaire: '' },
      };
    };

    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

    function App() {
      const [maintenanceId, setMaintenanceId] = useState(null);

      const [odFolders, setOdFolders] = useState([]);   // sous-dossiers de Maintenance/
      const [odSelected, setOdSelected] = useState(""); // sous-dossier choisi
      const [odLoading, setOdLoading] = useState(false);

      // Liste des JSON trouv√©s dans le chemin choisi
      const [odFiles, setOdFiles] = useState([]);

      const [templates, setTemplates] = useState(() => {
        try { const saved = localStorage.getItem('edl_templates'); return saved ? JSON.parse(saved) : { 'default': defaultTemplate }; }
        catch { return { 'default': defaultTemplate }; }
      });
      const [currentTemplate, setCurrentTemplate] = useState('default');
      const [data, setData] = useState(() => templateToData(defaultTemplate));
      const [activeTab, setActiveTab] = useState('info');
      const [expandedPiece, setExpandedPiece] = useState(null);
      const [showPrint, setShowPrint] = useState(false);
      const [selectedPhoto, setSelectedPhoto] = useState(null);
      const [showConfig, setShowConfig] = useState(false);
      const [configTab, setConfigTab] = useState('appartements');
      const [showComparison, setShowComparison] = useState(false);
      const [savedEdls, setSavedEdls] = useState(() => {
        try { const saved = localStorage.getItem('edl_saved'); return saved ? JSON.parse(saved) : []; }
        catch { return []; }
      });
      const [entryData, setEntryData] = useState(null);
      const [exitData, setExitData] = useState(null);
      const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
      
      // IMPORTANT: Ces √©tats sont au niveau App pour persister quand le modal se re-render
      const [configSelectedTemplate, setConfigSelectedTemplate] = useState('default');
      const [configExpandedPiece, setConfigExpandedPiece] = useState(null);
      const [configCreateStep, setConfigCreateStep] = useState(0);

      useEffect(() => { try { localStorage.setItem('edl_templates', JSON.stringify(templates)); } catch {} }, [templates]);
      useEffect(() => { try { localStorage.setItem('edl_saved', JSON.stringify(savedEdls)); } catch {} }, [savedEdls]);

      const refreshOneDriveFolders = async () => {
  setOdLoading(true);
  try {
    // 1) r√©soudre Maintenance -> ID (1 fois)
    let id = maintenanceId;
    if (!id) {
      id = await getDriveItemIdByPath("Maintenance");
      setMaintenanceId(id);
    }

    // 2) lister les sous-dossiers via ID
    const items = await listChildrenById(id);
    const folders = items.filter(i => i.folder);

    setOdFolders(folders);
    if (!odSelected && folders.length) setOdSelected(folders[0].name);

  } catch (e) {
    console.error(e);
    alert(`Impossible de lister "Maintenance" via Graph.\nD√©tail: ${e.message}`);
  } finally {
    setOdLoading(false);
  }
};


const saveEdlToOneDrive = async () => {
  if (!odSelected) {
    alert("Choisis d'abord un sous-dossier de Maintenance (bouton üîÑ).");
    return;
  }

  const label = buildEdlName(data.info);
  const adresseFolder = slug(data.info.adresse || "Adresse");

  // Maintenance/<SousDossier>/<Adresse>/
  const folderPath = `${BASE_FOLDER}/${odSelected}/${adresseFolder}`;

  try {
    // cr√©e Maintenance/<SousDossier>/<Adresse> si besoin
    await ensureFolderPath(folderPath);

    await uploadTextToOneDrive(
      folderPath,
      `${label}.json`,
      JSON.stringify(deepClone(data), null, 2)
    );

    alert("‚úÖ JSON sauvegard√© sur OneDrive");
  } catch (e) {
    console.error(e);
    alert("Erreur sauvegarde OneDrive (voir console)");
  }
};

const listEdlsFromOneDrive = async () => {
  if (!odSelected) {
    alert("Choisis d'abord un sous-dossier de Maintenance (bouton üîÑ).");
    return;
  }
  const adresseFolder = slug(data.info.adresse || "Adresse");
  const folderPath = `${BASE_FOLDER}/${odSelected}/${adresseFolder}`;

  setOdLoading(true);
  try {
    const items = await listOneDriveChildren(folderPath);
    const jsons = items
      .filter((i) => i.file && i.name && i.name.toLowerCase().endsWith(".json"))
      .sort((a, b) => (b.lastModifiedDateTime || "").localeCompare(a.lastModifiedDateTime || ""));
    setOdFiles(jsons);
    if (!jsons.length) alert("Aucun JSON trouv√© dans ce dossier.");
  } catch (e) {
    console.error(e);
    alert("Impossible de lister les JSON (dossier Adresse peut-√™tre absent).");
  } finally {
    setOdLoading(false);
  }
};

const loadEdlFromOneDrive = async (fileName) => {
  const adresseFolder = slug(data.info.adresse || "Adresse");
  const filePath = `${BASE_FOLDER}/${odSelected}/${adresseFolder}/${fileName}`;

  try {
    const txt = await downloadOneDriveText(filePath);
    const obj = JSON.parse(txt);
    setData(obj);
    setActiveTab("info");
    alert("‚úÖ EDL charg√© depuis OneDrive");
  } catch (e) {
    console.error(e);
    alert("Erreur chargement OneDrive");
  }
};


      const updateInfo = (field, value) => setData(prev => ({ ...prev, info: { ...prev.info, [field]: value } }));
      
      const updateEtatLieux = (pieceKey, itemId, field, value) => {
        setData(prev => ({
          ...prev,
          pieces: { ...prev.pieces, [pieceKey]: { ...prev.pieces[pieceKey], etatLieux: prev.pieces[pieceKey].etatLieux.map(item => item.id === itemId ? { ...item, [field]: value } : item) } }
        }));
      };

      const updateInventaire = (pieceKey, itemId, field, value) => {
        setData(prev => ({
          ...prev,
          pieces: { ...prev.pieces, [pieceKey]: { ...prev.pieces[pieceKey], inventaire: prev.pieces[pieceKey].inventaire.map(item => item.id === itemId ? { ...item, [field]: value } : item) } }
        }));
      };

      const updateCle = (cleId, field, value) => setData(prev => ({ ...prev, cles: prev.cles.map(cle => cle.id === cleId ? { ...cle, [field]: value } : cle) }));
      const updateSignature = (who, value) => setData(prev => ({ ...prev, signatures: { ...prev.signatures, [who]: value } }));

      const addPieceToTemplate = (templateKey, pieceName) => {
        const pieceId = pieceName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '') + '_' + Date.now();
        const maxOrdre = Math.max(...Object.values(templates[templateKey].pieces).map(p => p.ordre || 0), 0);
        setTemplates(prev => ({
          ...prev, [templateKey]: { ...prev[templateKey], pieces: { ...prev[templateKey].pieces, [pieceId]: {
            nom: pieceName, ordre: maxOrdre + 1,
            etatLieux: [{ id: 'rev_sol', nom: 'Rev√™tement de sol' }, { id: 'murs', nom: 'Murs et plafond' }, { id: 'fenetre', nom: 'Fen√™tre' }, { id: 'portes', nom: 'Porte(s)' }, { id: 'luminaires', nom: 'Luminaires' }],
            inventaire: [],
          }}}
        }));
      };

      const removePieceFromTemplate = (templateKey, pieceKey) => {
        if (window.confirm(`Supprimer "${templates[templateKey].pieces[pieceKey].nom}" ?`)) {
          const newPieces = { ...templates[templateKey].pieces };
          delete newPieces[pieceKey];
          setTemplates(prev => ({ ...prev, [templateKey]: { ...prev[templateKey], pieces: newPieces } }));
        }
      };

      const saveAsTemplate = (name) => {
        const templateKey = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '') + '_' + Date.now();
        const template = { nom: name, pieces: {}, cles: data.cles.map(({ id, nom, qte }) => ({ id, nom, qte })) };
        Object.entries(data.pieces).forEach(([key, piece]) => {
          template.pieces[key] = { nom: piece.nom, ordre: piece.ordre || 0, etatLieux: piece.etatLieux.map(({ id, nom }) => ({ id, nom })), inventaire: piece.inventaire.map(({ id, nom, qte }) => ({ id, nom, qte })) };
        });
        setTemplates(prev => ({ ...prev, [templateKey]: template }));
        setConfigSelectedTemplate(templateKey);
      };

      const loadTemplate = (templateKey) => {
        const template = templates[templateKey];
        if (template) { setData(templateToData(template, data.info.type)); setCurrentTemplate(templateKey); }
      };

      const deleteTemplate = (templateKey) => {
        if (templateKey === 'default') return;
        if (window.confirm(`Supprimer "${templates[templateKey].nom}" ?`)) {
          const newTemplates = { ...templates }; delete newTemplates[templateKey]; setTemplates(newTemplates);
          if (currentTemplate === templateKey) loadTemplate('default');
          if (configSelectedTemplate === templateKey) setConfigSelectedTemplate('default');
        }
      };

      const updateTemplateItem = (templateKey, pieceKey, type, itemId, field, value) => {
        setTemplates(prev => ({
          ...prev, [templateKey]: { ...prev[templateKey], pieces: { ...prev[templateKey].pieces, [pieceKey]: { ...prev[templateKey].pieces[pieceKey], [type]: prev[templateKey].pieces[pieceKey][type].map(item => item.id === itemId ? { ...item, [field]: value } : item) } } }
        }));
      };

      const addTemplateItem = (templateKey, pieceKey, type, item) => {
        setTemplates(prev => ({
          ...prev, [templateKey]: { ...prev[templateKey], pieces: { ...prev[templateKey].pieces, [pieceKey]: { ...prev[templateKey].pieces[pieceKey], [type]: [...prev[templateKey].pieces[pieceKey][type], item] } } }
        }));
      };

      const removeTemplateItem = (templateKey, pieceKey, type, itemId) => {
        setTemplates(prev => ({
          ...prev, [templateKey]: { ...prev[templateKey], pieces: { ...prev[templateKey].pieces, [pieceKey]: { ...prev[templateKey].pieces[pieceKey], [type]: prev[templateKey].pieces[pieceKey][type].filter(item => item.id !== itemId) } } }
        }));
      };

      const saveCurrentEdl = () => {
  const label = buildEdlName(data.info);
  setSavedEdls(prev => [
    ...prev,
    { id: Date.now(), label, data: deepClone(data), savedAt: new Date().toISOString(), templateKey: currentTemplate }
  ]);
  alert('√âtat des lieux sauvegard√© !');
};


      const loadEdl = (edl) => { 
        if (!edl || !edl.data) {
          alert('Erreur: donn√©es invalides');
          return;
        }
        // Charger les donn√©es
        setData(deepClone(edl.data)); 
        // Mettre √† jour le template si disponible
        if (edl.templateKey && templates[edl.templateKey]) {
          setCurrentTemplate(edl.templateKey);
        }
        // Retourner √† l'onglet info
        setActiveTab('info');
        // Feedback utilisateur
        alert('‚úÖ √âtat des lieux charg√© !\n\n' + 
          'Type: ' + (edl.data.info.type === 'entree' ? 'Entr√©e' : 'Sortie') + '\n' +
          'Appartement: ' + edl.data.info.appartement + '\n' +
          'Date: ' + edl.data.info.date
        );
      };
      const deleteEdl = (edlId) => { if (window.confirm('Supprimer cette sauvegarde ?')) setSavedEdls(prev => prev.filter(e => e.id !== edlId)); };

      const getComparisonStatus = (entryItem, exitItem) => {
        if (!entryItem || !exitItem) return 'unknown';
        if (entryItem.etat === exitItem.etat) return 'same';
        if (entryItem.etat === 'Bon' && exitItem.etat !== 'Bon') return 'degraded';
        if (entryItem.etat !== 'Bon' && exitItem.etat === 'Bon') return 'improved';
        return 'changed';
      };

      const handlePhotoCapture = (e, updateFn, currentPhotos) => {
        Array.from(e.target.files).forEach(file => {
          const reader = new FileReader();
          reader.onloadend = () => updateFn([...currentPhotos, { id: Date.now() + Math.random(), data: reader.result, timestamp: new Date().toISOString() }]);
          reader.readAsDataURL(file);
        });
        e.target.value = '';
      };

      const generatePDF = async () => {
        setIsGeneratingPdf(true);
        if (!window.html2pdf) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
            script.onload = resolve; script.onerror = reject;
            document.body.appendChild(script);
          });
        }
        setShowPrint(true);
        setTimeout(async () => {
          try {
            const element = document.getElementById('print-content');
            await window.html2pdf().set({
              margin: [10, 10, 15, 10], // top, left, bottom, right
              filename: `${buildEdlName(data.info)}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { 
                scale: 2,
                useCORS: true,
                logging: false
              },
              jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait'
              },
              pagebreak: { 
                mode: ['avoid-all', 'css', 'legacy'],
                before: '.page-break-before',
                after: '.page-break-after',
                avoid: ['tr', 'td', '.no-break']
              }
            }).from(element).save();
          } catch (err) { 
            console.error(err);
            alert('Erreur PDF'); 
          }
          setShowPrint(false); 
          setIsGeneratingPdf(false);
        }, 500);
      };

      const exportJSON = () => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `${buildEdlName(data.info)}.json`; a.click();
      };

      const exportTemplates = () => {
        const blob = new Blob([JSON.stringify(templates, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `modeles-appartements.json`; a.click();
      };

      const importTemplates = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => { try { setTemplates(prev => ({ ...prev, ...JSON.parse(event.target.result) })); alert('Import√© !'); } catch { alert('Erreur'); } };
          reader.readAsText(file);
        }
      };

      const resetForm = () => { if (window.confirm('R√©initialiser ?')) { setData(templateToData(templates[currentTemplate], data.info.type)); setActiveTab('info'); } };

      const resetTemplates = (alsoDeleteSavedEdls = false) => {
        const msg = alsoDeleteSavedEdls
          ? "R√©initialiser les mod√®les ET supprimer les √©tats des lieux sauvegard√©s ?"
          : "R√©initialiser les mod√®les (mod√®le par d√©faut) ?";

          if (!window.confirm(msg)) return;

          try {
            localStorage.removeItem('edl_templates');
          if (alsoDeleteSavedEdls) localStorage.removeItem('edl_saved');
        } catch (e) {}

        window.location.reload();
      };


      const countPhotos = () => {
        let total = 0;
        Object.values(data.pieces).forEach(piece => { piece.etatLieux.forEach(item => total += item.photos.length); piece.inventaire.forEach(item => total += item.photos.length); });
        data.cles.forEach(cle => total += cle.photos.length);
        return total;
      };

      const sortedPieces = Object.entries(data.pieces).sort((a, b) => (a[1].ordre || 0) - (b[1].ordre || 0));
      const totalPhotos = countPhotos();

      const EtatButton = ({ value, selected, onClick }) => (
        <button onClick={() => onClick(value)} className={`px-2 py-1 text-xs rounded-lg border transition-all ${selected ? value === 'Bon' ? 'bg-green-500 text-white' : value === 'Appropri√©' ? 'bg-yellow-500 text-white' : value === 'Mauvais' ? 'bg-red-500 text-white' : 'bg-gray-500 text-white' : 'bg-white text-gray-700 border-gray-300'}`}>
          {value}
        </button>
      );

      const TabButton = ({ id, icon, label, active, badge }) => (
        <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-center p-2 flex-1 transition-all relative ${active ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500'}`}>
          <Icon name={icon} size={20} />
          <span className="text-xs mt-1">{label}</span>
          {badge > 0 && <span className="absolute top-1 right-1/4 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">{badge > 9 ? '9+' : badge}</span>}
        </button>
      );

      const PhotoGallery = ({ photos, onRemove, inputId, onAddPhoto }) => (
        <div className="mt-2 flex flex-wrap gap-2">
          {photos.map((photo, idx) => (
            <div key={photo.id} className="relative">
              <img src={photo.data} alt="" className="w-14 h-14 object-cover rounded-lg border cursor-pointer" onClick={() => setSelectedPhoto(photo)} />
              <button onClick={() => onRemove(photo.id)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs flex items-center justify-center">√ó</button>
            </div>
          ))}
          <label htmlFor={inputId} className="w-14 h-14 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-blue-400">
            <Icon name="Camera" size={16} className="text-gray-400" />
            <span className="text-xs text-gray-400">Photo</span>
          </label>
          <input type="file" id={inputId} accept="image/*" capture="environment" multiple className="hidden" onChange={onAddPhoto} />
        </div>
      );

      const PieceSection = ({ pieceKey, piece }) => {
        const isExpanded = expandedPiece === pieceKey;
        const photoCount = [...piece.etatLieux, ...piece.inventaire].reduce((acc, item) => acc + item.photos.length, 0);
        return (
          <div className="mb-3 bg-white rounded-xl shadow-sm border overflow-hidden">
            <button onClick={() => setExpandedPiece(isExpanded ? null : pieceKey)} className="w-full flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-indigo-50">
              <div className="flex items-center gap-2">
                <span className="font-semibold text-gray-800">{piece.nom}</span>
                {photoCount > 0 && <span className="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full">üì∑ {photoCount}</span>}
              </div>
              <Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} size={20} />
            </button>
            {isExpanded && (
              <div className="p-3 space-y-4">
                {piece.etatLieux.length > 0 && (
                  <div>
                    <h4 className="font-medium text-sm text-blue-700 mb-2">üè† √âtat des lieux</h4>
                    <div className="space-y-3">
                      {piece.etatLieux.map(item => (
                        <div key={item.id} className="bg-gray-50 p-3 rounded-lg">
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-medium text-sm">{item.nom}</span>
                            {item.photos.length > 0 && <span className="text-xs text-blue-600">üì∑ {item.photos.length}</span>}
                          </div>
                          <div className="flex flex-wrap gap-1 mb-2">
                            {ETAT_OPTIONS.map(opt => <EtatButton key={opt} value={opt} selected={item.etat === opt} onClick={(v) => updateEtatLieux(pieceKey, item.id, 'etat', v)} />)}
                          </div>
                          <input type="text" placeholder="Commentaire..." defaultValue={item.commentaire} onBlur={(e) => updateEtatLieux(pieceKey, item.id, 'commentaire', e.target.value)} className="w-full text-sm p-2 border rounded-lg mb-2" />
                          <PhotoGallery photos={item.photos} onRemove={(photoId) => updateEtatLieux(pieceKey, item.id, 'photos', item.photos.filter(p => p.id !== photoId))} inputId={`p-e-${pieceKey}-${item.id}`} onAddPhoto={(e) => handlePhotoCapture(e, (photos) => updateEtatLieux(pieceKey, item.id, 'photos', photos), item.photos)} />
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                {piece.inventaire.length > 0 && (
                  <div>
                    <h4 className="font-medium text-sm text-green-700 mb-2">üìã Inventaire</h4>
                    <div className="space-y-3">
                      {piece.inventaire.map(item => (
                        <div key={item.id} className="bg-gray-50 p-3 rounded-lg">
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-medium text-sm">{item.nom}</span>
                            <div className="flex items-center gap-2">
                              <span className="text-xs text-gray-500">Qt√©:</span>
                              <input type="number" min="0" value={item.qte} onChange={(e) => updateInventaire(pieceKey, item.id, 'qte', parseInt(e.target.value) || 0)} className="w-12 text-center text-sm p-1 border rounded" />
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-1 mb-2">
                            {ETAT_OPTIONS.map(opt => <EtatButton key={opt} value={opt} selected={item.etat === opt} onClick={(v) => updateInventaire(pieceKey, item.id, 'etat', v)} />)}
                          </div>
                          <input type="text" placeholder="Commentaire..." defaultValue={item.commentaire} onBlur={(e) => updateInventaire(pieceKey, item.id, 'commentaire', e.target.value)}  className="w-full text-sm p-2 border rounded-lg mb-2" />
                          <PhotoGallery photos={item.photos} onRemove={(photoId) => updateInventaire(pieceKey, item.id, 'photos', item.photos.filter(p => p.id !== photoId))} inputId={`p-i-${pieceKey}-${item.id}`} onAddPhoto={(e) => handlePhotoCapture(e, (photos) => updateInventaire(pieceKey, item.id, 'photos', photos), item.photos)} />
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        );
      };

      // Config Modal - Les √©tats sont remont√©s dans App pour persister
      const ConfigModal = () => {
        const [newTemplateName, setNewTemplateName] = useState('');
        const [newPieceName, setNewPieceName] = useState('');
        const [newItemName, setNewItemName] = useState('');
        const [newItemQte, setNewItemQte] = useState('1');
        const [editingPieceKey, setEditingPieceKey] = useState(null);
        const [editingTemplateKey, setEditingTemplateKey] = useState(null);
        // √âtats locaux pour les inputs de quantit√© (pour pouvoir vider le champ)
        const [localQtes, setLocalQtes] = useState({});
        
        const template = templates[configSelectedTemplate];

        // Fonction pour renommer un mod√®le
        const renameTemplate = (templateKey, newName) => {
          setTemplates(prev => ({
            ...prev,
            [templateKey]: {
              ...prev[templateKey],
              nom: newName
            }
          }));
        };

        // Fonction pour renommer une pi√®ce
        const renamePiece = (templateKey, pieceKey, newName) => {
          setTemplates(prev => ({
            ...prev,
            [templateKey]: {
              ...prev[templateKey],
              pieces: {
                ...prev[templateKey].pieces,
                [pieceKey]: {
                  ...prev[templateKey].pieces[pieceKey],
                  nom: newName
                }
              }
            }
          }));
        };

        // Fonction pour dupliquer une pi√®ce
        const duplicatePiece = (templateKey, pieceKey) => {
          const piece = templates[templateKey].pieces[pieceKey];
          const newPieceId = 'piece_' + Date.now();
          const maxOrdre = Math.max(...Object.values(templates[templateKey].pieces).map(p => p.ordre || 0), 0);
          
          // Cr√©er une copie profonde de la pi√®ce
          const newPiece = {
            nom: piece.nom + ' (copie)',
            ordre: maxOrdre + 1,
            etatLieux: piece.etatLieux.map(item => ({ ...item, id: item.id + '_' + Date.now() })),
            inventaire: piece.inventaire.map(item => ({ ...item, id: item.id + '_' + Date.now() }))
          };
          
          setTemplates(prev => ({
            ...prev,
            [templateKey]: {
              ...prev[templateKey],
              pieces: {
                ...prev[templateKey].pieces,
                [newPieceId]: newPiece
              }
            }
          }));
        };

        // Fonction pour g√©rer le champ quantit√© avec possibilit√© de vider
        const handleQteChange = (pieceKey, itemId, value) => {
          // Permet de vider le champ temporairement
          const key = `${pieceKey}-${itemId}`;
          setLocalQtes(prev => ({ ...prev, [key]: value }));
        };

        const handleQteBlur = (pieceKey, itemId, value) => {
          const key = `${pieceKey}-${itemId}`;
          const numValue = parseInt(value) || 0;
          updateTemplateItem(configSelectedTemplate, pieceKey, 'inventaire', itemId, 'qte', numValue);
          // Nettoyer l'√©tat local
          setLocalQtes(prev => {
            const newState = { ...prev };
            delete newState[key];
            return newState;
          });
        };

        const getQteValue = (pieceKey, itemId, originalValue) => {
          const key = `${pieceKey}-${itemId}`;
          return localQtes.hasOwnProperty(key) ? localQtes[key] : originalValue;
        };

        return (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center">
            <div className="bg-white w-full max-w-lg max-h-[90vh] rounded-t-2xl sm:rounded-2xl overflow-hidden flex flex-col">
              <div className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 flex items-center justify-between">
                <h2 className="font-bold text-lg">‚öôÔ∏è Configuration</h2>
                <button onClick={() => { setShowConfig(false); setConfigCreateStep(0); }} className="p-2 text-xl">‚úï</button>
              </div>
              <div className="flex border-b text-sm">
                {['appartements', 'pieces', 'inventaire', 'export'].map(tab => (
                  <button key={tab} onClick={() => setConfigTab(tab)} className={`flex-1 py-3 font-medium capitalize ${configTab === tab ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500'}`}>{tab}</button>
                ))}
              </div>
              <div className="flex-1 overflow-auto p-4">
                
                {/* ONGLET APPARTEMENTS */}
                {configTab === 'appartements' && (
                  <div className="space-y-4">
                    {/* Instructions */}
                    <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg text-sm">
                      <p className="font-medium text-blue-800 mb-1">üí° Comment utiliser les mod√®les :</p>
                      <ol className="text-blue-700 list-decimal list-inside space-y-1 text-xs">
                        <li><strong>Cr√©ez</strong> un mod√®le pour chaque appartement</li>
                        <li><strong>Personnalisez</strong> les pi√®ces et l'inventaire (onglets suivants)</li>
                        <li><strong>Chargez</strong> le bon mod√®le avant chaque √©tat des lieux</li>
                      </ol>
                    </div>

                    {configCreateStep === 0 ? (
                      <>
                        {/* Bouton cr√©ation */}
                        <button 
                          onClick={() => setConfigCreateStep(1)} 
                          className="w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-medium text-lg shadow-md"
                        >
                          ‚ûï Cr√©er un nouveau mod√®le
                        </button>

                        {/* Liste des mod√®les */}
                        <div>
                          <label className="text-sm font-medium text-gray-600 mb-2 block">Vos mod√®les ({Object.keys(templates).length})</label>
                          <div className="space-y-2">
                            {Object.entries(templates).map(([key, tpl]) => (
                              <div key={key} className={`p-3 rounded-xl border-2 transition-all ${configSelectedTemplate === key ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-gray-300'}`}>
                                <div className="flex items-center justify-between">
                                  {editingTemplateKey === key ? (
                                    <input
                                      type="text"
                                      defaultValue={tpl.nom}
                                      autoFocus
                                      onFocus={(e) => e.target.select()}
                                      onBlur={(e) => {
                                        if (e.target.value.trim()) {
                                          renameTemplate(key, e.target.value.trim());
                                        }
                                        setEditingTemplateKey(null);
                                      }}
                                      onKeyDown={(e) => {
                                        if (e.key === 'Enter' && e.target.value.trim()) {
                                          renameTemplate(key, e.target.value.trim());
                                          setEditingTemplateKey(null);
                                        }
                                        if (e.key === 'Escape') {
                                          setEditingTemplateKey(null);
                                        }
                                      }}
                                      className="flex-1 p-2 border-2 border-purple-500 rounded-lg font-medium mr-2"
                                    />
                                  ) : (
                                    <button onClick={() => setConfigSelectedTemplate(key)} className="flex-1 text-left">
                                      <span className="font-medium">{tpl.nom}</span>
                                      {key === 'default' && <span className="ml-2 text-xs text-gray-400">(d√©faut)</span>}
                                      {currentTemplate === key && <span className="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">actif</span>}
                                    </button>
                                  )}
                                  <div className="flex items-center gap-1">
                                    <button 
                                      onClick={() => setEditingTemplateKey(key)} 
                                      className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"
                                      title="Renommer"
                                    >
                                      ‚úèÔ∏è
                                    </button>
                                    {key !== 'default' && (
                                      <button onClick={() => deleteTemplate(key)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg">üóë</button>
                                    )}
                                  </div>
                                </div>
                                {configSelectedTemplate === key && !editingTemplateKey && (
                                  <div className="mt-3 pt-3 border-t border-purple-200">
                                    <p className="text-xs text-gray-500 mb-2">{Object.keys(tpl.pieces).length} pi√®ces configur√©es</p>
                                    <div className="flex gap-2">
                                      <button 
                                        onClick={() => { loadTemplate(key); setShowConfig(false); }} 
                                        className="flex-1 py-2 bg-purple-600 text-white rounded-lg font-medium"
                                      >
                                        ‚úì Utiliser ce mod√®le
                                      </button>
                                      <button 
                                        onClick={() => setConfigTab('pieces')} 
                                        className="px-4 py-2 bg-gray-200 rounded-lg"
                                      >
                                        ‚úèÔ∏è
                                      </button>
                                    </div>
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      </>
                    ) : (
                      /* Formulaire cr√©ation */
                      <div className="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-200 p-4 rounded-xl">
                        <h3 className="font-bold text-purple-800 mb-3 text-lg">Nouveau mod√®le</h3>
                        <input 
                          type="text" 
                          value={newTemplateName} 
                          onChange={(e) => setNewTemplateName(e.target.value)} 
                          placeholder="Nom de l'appartement (ex: 33C Cellerier)" 
                          className="w-full p-3 border-2 border-purple-300 rounded-lg text-lg mb-3"
                          autoFocus
                        />
                        <p className="text-xs text-purple-600 mb-4">
                          üí° Le mod√®le sera cr√©√© avec la configuration de base. Vous pourrez ensuite ajouter/supprimer des pi√®ces et ajuster l'inventaire.
                        </p>
                        <div className="flex gap-2">
                          <button 
                            onClick={() => { setConfigCreateStep(0); setNewTemplateName(''); }} 
                            className="flex-1 py-3 bg-gray-200 rounded-lg font-medium"
                          >
                            Annuler
                          </button>
                          <button 
                            onClick={() => { 
                              if (newTemplateName.trim()) { 
                                saveAsTemplate(newTemplateName.trim()); 
                                setNewTemplateName(''); 
                                setConfigCreateStep(0);
                                alert('‚úÖ Mod√®le "' + newTemplateName.trim() + '" cr√©√© avec succ√®s !\n\nAllez dans l\'onglet "Pi√®ces" ou "Inventaire" pour le personnaliser.');
                              } 
                            }} 
                            disabled={!newTemplateName.trim()}
                            className="flex-1 py-3 bg-purple-600 text-white rounded-lg font-medium disabled:opacity-50"
                          >
                            ‚úì Cr√©er
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* ONGLET PIECES */}
                {configTab === 'pieces' && (
                  <div className="space-y-4">
                    <div className="bg-yellow-50 border border-yellow-200 p-2 rounded-lg text-sm flex items-center gap-2">
                      <span>üìÅ</span>
                      <span>Mod√®le : <strong>{template.nom}</strong></span>
                    </div>
                    
                    <div className="bg-blue-50 p-3 rounded-lg">
                      <label className="block text-sm font-medium mb-2">‚ûï Ajouter une pi√®ce</label>
                      <div className="flex gap-2">
                        <input 
                          type="text" 
                          value={newPieceName} 
                          onChange={(e) => setNewPieceName(e.target.value)} 
                          placeholder="Nom (ex: Chambre 2, Cave...)" 
                          className="flex-1 p-3 border rounded-lg" 
                        />
                        <button 
                          onClick={() => { if (newPieceName.trim()) { addPieceToTemplate(configSelectedTemplate, newPieceName.trim()); setNewPieceName(''); } }} 
                          className="px-5 py-3 bg-blue-600 text-white rounded-lg font-bold text-lg"
                        >
                          +
                        </button>
                      </div>
                    </div>

                    <div className="space-y-2">
                      <label className="text-sm font-medium text-gray-600">Pi√®ces du mod√®le :</label>
                      <p className="text-xs text-gray-400">‚úèÔ∏è Renommer ‚Ä¢ üìã Dupliquer ‚Ä¢ üóë Supprimer</p>
                      {Object.entries(template.pieces).sort((a, b) => (a[1].ordre || 0) - (b[1].ordre || 0)).map(([pieceKey, piece]) => (
                        <div key={pieceKey} className="flex items-center justify-between p-3 bg-white border rounded-lg">
                          {editingPieceKey === pieceKey ? (
                            <input
                              type="text"
                              defaultValue={piece.nom}
                              autoFocus
                              onFocus={(e) => e.target.select()}
                              onBlur={(e) => {
                                if (e.target.value.trim()) {
                                  renamePiece(configSelectedTemplate, pieceKey, e.target.value.trim());
                                }
                                setEditingPieceKey(null);
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter' && e.target.value.trim()) {
                                  renamePiece(configSelectedTemplate, pieceKey, e.target.value.trim());
                                  setEditingPieceKey(null);
                                }
                                if (e.key === 'Escape') {
                                  setEditingPieceKey(null);
                                }
                              }}
                              className="flex-1 p-2 border-2 border-blue-500 rounded-lg font-medium mr-2"
                            />
                          ) : (
                            <span className="font-medium flex-1">{piece.nom}</span>
                          )}
                          <div className="flex items-center gap-1">
                            <span className="text-xs text-gray-400 mr-1">{piece.etatLieux.length}+{piece.inventaire.length}</span>
                            <button 
                              onClick={() => setEditingPieceKey(pieceKey)} 
                              className="p-2 text-blue-500 hover:bg-blue-50 rounded"
                              title="Renommer"
                            >
                              ‚úèÔ∏è
                            </button>
                            <button 
                              onClick={() => duplicatePiece(configSelectedTemplate, pieceKey)} 
                              className="p-2 text-green-600 hover:bg-green-50 rounded"
                              title="Dupliquer"
                            >
                              üìã
                            </button>
                            <button 
                              onClick={() => removePieceFromTemplate(configSelectedTemplate, pieceKey)} 
                              className="p-2 text-red-500 hover:bg-red-50 rounded"
                              title="Supprimer"
                            >
                              üóë
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* ONGLET INVENTAIRE */}
                {configTab === 'inventaire' && (
                  <div className="space-y-3">
                    <div className="bg-yellow-50 border border-yellow-200 p-2 rounded-lg text-sm flex items-center gap-2">
                      <span>üìÅ</span>
                      <span>Mod√®le : <strong>{template.nom}</strong></span>
                    </div>
                    <p className="text-xs text-gray-500">üëÜ Cliquez sur une pi√®ce pour modifier son contenu. Les menus restent ouverts pendant vos modifications.</p>
                    
                    {Object.entries(template.pieces).sort((a, b) => (a[1].ordre || 0) - (b[1].ordre || 0)).map(([pieceKey, piece]) => (
                      <div key={pieceKey} className="border rounded-lg overflow-hidden bg-white">
                        <button 
                          onClick={() => setConfigExpandedPiece(configExpandedPiece === pieceKey ? null : pieceKey)} 
                          className="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100"
                        >
                          <span className="font-medium">{piece.nom}</span>
                          <div className="flex items-center gap-2">
                            <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">{piece.etatLieux.length}</span>
                            <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">{piece.inventaire.length}</span>
                            <span className="text-lg">{configExpandedPiece === pieceKey ? '‚ñ≤' : '‚ñº'}</span>
                          </div>
                        </button>
                        
                        {configExpandedPiece === pieceKey && (
                          <div className="p-3 space-y-4 bg-gray-50">
                            {/* √âtat des lieux */}
                            <div className="bg-white p-3 rounded-lg border">
                              <h5 className="font-semibold text-blue-700 mb-2 text-sm">üè† √âl√©ments √©tat des lieux</h5>
                              <div className="space-y-1 mb-3">
                                {piece.etatLieux.map(item => (
                                  <div key={item.id} className="flex items-center justify-between py-2 px-2 bg-blue-50 rounded">
                                    <span className="text-sm">{item.nom}</span>
                                    <button 
                                      onClick={() => removeTemplateItem(configSelectedTemplate, pieceKey, 'etatLieux', item.id)} 
                                      className="p-1.5 text-red-500 hover:bg-red-100 rounded text-lg"
                                    >
                                      ‚úï
                                    </button>
                                  </div>
                                ))}
                                {piece.etatLieux.length === 0 && <p className="text-xs text-gray-400 italic">Aucun √©l√©ment</p>}
                              </div>
                              <div className="flex gap-2">
                                <input 
                                  type="text" 
                                  placeholder="Nouvel √©l√©ment..." 
                                  value={newItemName} 
                                  onChange={(e) => setNewItemName(e.target.value)} 
                                  className="flex-1 p-2 border rounded" 
                                />
                                <button 
                                  onClick={() => { 
                                    if (newItemName.trim()) { 
                                      addTemplateItem(configSelectedTemplate, pieceKey, 'etatLieux', { id: `c_${Date.now()}`, nom: newItemName.trim() }); 
                                      setNewItemName(''); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-blue-500 text-white rounded font-bold"
                                >
                                  +
                                </button>
                              </div>
                            </div>

                            {/* Inventaire */}
                            <div className="bg-white p-3 rounded-lg border">
                              <h5 className="font-semibold text-green-700 mb-2 text-sm">üìã √âl√©ments inventaire</h5>
                              <div className="space-y-1 mb-3">
                                {piece.inventaire.map(item => (
                                  <div key={item.id} className="flex items-center justify-between py-2 px-2 bg-green-50 rounded">
                                    <span className="text-sm flex-1">{item.nom}</span>
                                    <div className="flex items-center gap-2">
                                      <span className="text-xs text-gray-500">Qt√©:</span>
                                      <input 
                                        type="text"
                                        inputMode="numeric"
                                        value={getQteValue(pieceKey, item.id, item.qte)}
                                        onChange={(e) => handleQteChange(pieceKey, item.id, e.target.value.replace(/[^0-9]/g, ''))}
                                        onBlur={(e) => handleQteBlur(pieceKey, item.id, e.target.value)}
                                        onFocus={(e) => e.target.select()}
                                        className="w-16 text-center p-2 border rounded text-sm" 
                                      />
                                      <button 
                                        onClick={() => removeTemplateItem(configSelectedTemplate, pieceKey, 'inventaire', item.id)} 
                                        className="p-1.5 text-red-500 hover:bg-red-100 rounded text-lg"
                                      >
                                        ‚úï
                                      </button>
                                    </div>
                                  </div>
                                ))}
                                {piece.inventaire.length === 0 && <p className="text-xs text-gray-400 italic">Aucun √©l√©ment</p>}
                              </div>
                              <div className="flex gap-2">
                                <input 
                                  type="text" 
                                  placeholder="Nouvel √©l√©ment..." 
                                  value={newItemName} 
                                  onChange={(e) => setNewItemName(e.target.value)} 
                                  className="flex-1 p-2 border rounded" 
                                />
                                <input 
                                  type="text"
                                  inputMode="numeric"
                                  value={newItemQte}
                                  onChange={(e) => setNewItemQte(e.target.value.replace(/[^0-9]/g, '') || '')}
                                  onFocus={(e) => e.target.select()}
                                  placeholder="Qt√©"
                                  className="w-16 text-center p-2 border rounded" 
                                />
                                <button 
                                  onClick={() => { 
                                    if (newItemName.trim()) { 
                                      addTemplateItem(configSelectedTemplate, pieceKey, 'inventaire', { id: `c_${Date.now()}`, nom: newItemName.trim(), qte: parseInt(newItemQte) || 1 }); 
                                      setNewItemName(''); 
                                      setNewItemQte('1'); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-green-500 text-white rounded font-bold"
                                >
                                  +
                                </button>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* ONGLET EXPORT */}
                {configTab === 'export' && (
                  <div className="space-y-6">
                    <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg text-sm">
                      <p className="font-medium text-blue-800 mb-1">üíæ Sauvegarde et transfert</p>
                      <p className="text-blue-700 text-xs">Exportez vos mod√®les pour les sauvegarder ou les transf√©rer sur un autre appareil.</p>
                    </div>
                    
                    <div className="space-y-5">
                      <button onClick={exportTemplates} className="w-full py-3 bg-purple-600 text-white rounded-lg font-medium">
                        üì§ Exporter tous les mod√®les
                      </button>
                      <label className="w-full py-3 bg-green-600 text-white rounded-lg font-medium flex items-center justify-center cursor-pointer">
                        üì• Importer des mod√®les
                        <input type="file" accept=".json" onChange={importTemplates} className="hidden" />
                      </label>
                      <hr className="my-2 border-gray-200" />
                      <button onClick={exportJSON} className="w-full py-3 bg-blue-600 text-white rounded-lg font-medium">
                        üíæ Exporter l'√©tat des lieux actuel
                      </button>
                      <hr className="my-2 border-gray-200" />
                      <button
                        onClick={() => resetTemplates(false)}
                        className="w-full py-3 bg-red-600 text-white rounded-lg font-medium"
                      >
                        ‚ôªÔ∏è R√©initialiser les mod√®les (default)
                      </button>

                      <button
                        onClick={() => resetTemplates(true)}
                        className="w-full py-3 bg-red-700 text-white rounded-lg font-medium"
                      >
                        üß® R√©initialiser mod√®les + supprimer les sauvegardes
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      // Comparison Modal
      const ComparisonModal = () => (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center">
          <div className="bg-white w-full max-w-4xl max-h-[90vh] rounded-t-2xl sm:rounded-2xl overflow-hidden flex flex-col">
            <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 flex items-center justify-between">
              <h2 className="font-bold text-lg">‚öñÔ∏è Comparatif Entr√©e / Sortie</h2>
              <button onClick={() => setShowComparison(false)}>‚úï</button>
            </div>
            <div className="flex-1 overflow-auto p-4">
              {!entryData || !exitData ? (
                <div className="space-y-4">
                  <p className="text-center text-gray-600">S√©lectionnez un √©tat d'entr√©e et un de sortie</p>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="border-2 border-green-200 rounded-lg p-3">
                      <h3 className="font-semibold text-green-700 mb-2">üì• Entr√©e</h3>
                      {entryData ? (
                        <div className="bg-green-50 p-2 rounded">
                          <p className="text-sm">{buildEdlName(entryData.info)}</p>
                          <button onClick={() => setEntryData(null)} className="text-xs text-red-500">Retirer</button>
                        </div>
                      ) : (
                        <div className="space-y-1">
                          {savedEdls.filter(e => e.data.info.type === 'entree').map(edl => (
                            <button key={edl.id} onClick={() => setEntryData(edl.data)} className="w-full text-left p-2 bg-gray-50 rounded hover:bg-green-50 text-sm">
                              {edl.label || buildEdlName(edl.data.info)}
                            </button>
                          ))}
                          {savedEdls.filter(e => e.data.info.type === 'entree').length === 0 && <p className="text-xs text-gray-400">Aucun</p>}
                        </div>
                      )}
                    </div>
                    <div className="border-2 border-orange-200 rounded-lg p-3">
                      <h3 className="font-semibold text-orange-700 mb-2">üì§ Sortie</h3>
                      {exitData ? (
                        <div className="bg-orange-50 p-2 rounded">
                          <p className="text-sm">{buildEdlName(exitData.info)}</p>
                          <button onClick={() => setExitData(null)} className="text-xs text-red-500">Retirer</button>
                        </div>
                      ) : (
                        <div className="space-y-1">
                          {savedEdls.filter(e => e.data.info.type === 'sortie').map(edl => (
                            <button key={edl.id} onClick={() => setExitData(edl.data)} className="w-full text-left p-2 bg-gray-50 rounded hover:bg-orange-50 text-sm">
                              {edl.label || buildEdlName(edl.data.info)}
                            </button>
                          ))}
                          {savedEdls.filter(e => e.data.info.type === 'sortie').length === 0 && <p className="text-xs text-gray-400">Aucun</p>}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="flex justify-between items-center bg-gray-100 p-2 rounded text-sm">
                    <span className="text-green-600">Entr√©e: {entryData.info.date}</span>
                    <span className="text-orange-600">Sortie: {exitData.info.date}</span>
                    <button onClick={() => { setEntryData(null); setExitData(null); }} className="text-blue-600 text-xs">Changer</button>
                  </div>
                  {Object.entries(entryData.pieces).map(([pieceKey, entryPiece]) => {
                    const exitPiece = exitData.pieces[pieceKey];
                    if (!exitPiece) return null;
                    return (
                      <div key={pieceKey} className="border rounded-lg overflow-hidden text-sm">
                        <div className="bg-blue-100 p-2 font-semibold">{entryPiece.nom}</div>
                        <table className="w-full">
                          <thead className="bg-gray-50"><tr><th className="p-1 text-left">√âl√©ment</th><th className="p-1 text-center text-green-600">Entr√©e</th><th className="p-1 text-center text-orange-600">Sortie</th><th className="p-1 text-center">√âvolution</th></tr></thead>
                          <tbody>
                            {entryPiece.etatLieux.map(entryItem => {
                              const exitItem = exitPiece.etatLieux.find(i => i.id === entryItem.id);
                              const status = getComparisonStatus(entryItem, exitItem);
                              return (
                                <tr key={entryItem.id} className="border-t">
                                  <td className="p-1">{entryItem.nom}</td>
                                  <td className="p-1 text-center"><span className={`px-1 rounded text-xs ${entryItem.etat === 'Bon' ? 'bg-green-200' : entryItem.etat === 'Appropri√©' ? 'bg-yellow-200' : entryItem.etat === 'Mauvais' ? 'bg-red-200' : 'bg-gray-200'}`}>{entryItem.etat || '-'}</span></td>
                                  <td className="p-1 text-center"><span className={`px-1 rounded text-xs ${exitItem?.etat === 'Bon' ? 'bg-green-200' : exitItem?.etat === 'Appropri√©' ? 'bg-yellow-200' : exitItem?.etat === 'Mauvais' ? 'bg-red-200' : 'bg-gray-200'}`}>{exitItem?.etat || '-'}</span></td>
                                  <td className="p-1 text-center">{status === 'same' ? '‚ïê' : status === 'degraded' ? <span className="text-red-500">‚Üì</span> : status === 'improved' ? <span className="text-green-500">‚Üë</span> : <span className="text-yellow-500">‚Üî</span>}</td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      );

      // Print View
      const PrintView = () => {
        const allPhotos = [];
        Object.entries(data.pieces).forEach(([_, piece]) => {
          [...piece.etatLieux, ...piece.inventaire].forEach(item => {
            item.photos.forEach(photo => allPhotos.push({ piece: piece.nom, element: item.nom, photo, index: allPhotos.length + 1 }));
          });
        });
        
        // Styles pour √©viter les coupures
        const noBreakInside = { pageBreakInside: 'avoid', breakInside: 'avoid' };
        const noBreakAfter = { pageBreakAfter: 'avoid', breakAfter: 'avoid' };
        const breakBefore = { pageBreakBefore: 'always', breakBefore: 'page' };
        
        return (
          <div className="fixed inset-0 bg-white z-50 overflow-auto">
            <div className="max-w-3xl mx-auto p-4">
              <div className="flex justify-between items-center mb-4 no-print">
                <h2 className="text-xl font-bold">Aper√ßu</h2>
                <div className="flex gap-2">
                  <button onClick={generatePDF} disabled={isGeneratingPdf} className="px-3 py-2 bg-red-600 text-white rounded-lg text-sm disabled:opacity-50">{isGeneratingPdf ? '...' : 'üìÑ PDF'}</button>
                  <button onClick={() => window.print()} className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">üñ® Imprimer</button>
                  <button onClick={() => setShowPrint(false)} className="px-3 py-2 bg-gray-200 rounded-lg">‚úï</button>
                </div>
              </div>
              <div id="print-content" style={{ fontFamily: 'Arial, sans-serif', fontSize: '11px', lineHeight: '1.4' }}>
                
                {/* EN-T√äTE */}
                <div style={{ ...noBreakInside, marginBottom: '20px', borderBottom: '2px solid #1e40af', paddingBottom: '15px' }}>
                  <h1 style={{ fontSize: '20px', fontWeight: 'bold', textAlign: 'center', textTransform: 'uppercase', margin: '0 0 5px 0' }}>
                    √âtat des lieux {data.info.type}
                  </h1>
                  <p style={{ fontSize: '14px', textAlign: 'center', color: '#4b5563', margin: 0 }}>{data.info.appartement}</p>
                </div>
                
                {/* INFOS G√âN√âRALES */}
                <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: '20px', ...noBreakInside }}>
                  <tbody>
                    <tr>
                      <td style={{ padding: '8px', border: '1px solid #d1d5db', backgroundColor: '#f3f4f6', fontWeight: '600', width: '20%' }}>Propri√©taire</td>
                      <td style={{ padding: '8px', border: '1px solid #d1d5db', width: '30%' }}>{data.info.proprietaire || '-'}</td>
                      <td style={{ padding: '8px', border: '1px solid #d1d5db', backgroundColor: '#f3f4f6', fontWeight: '600', width: '20%' }}>Locataire</td>
                      <td style={{ padding: '8px', border: '1px solid #d1d5db', width: '30%' }}>{data.info.locataire || '-'}</td>
                    </tr>
                    <tr>
                      <td style={{ padding: '8px', border: '1px solid #d1d5db', backgroundColor: '#f3f4f6', fontWeight: '600' }}>Date</td>
                      <td style={{ padding: '8px', border: '1px solid #d1d5db' }}>{data.info.date}</td>
                      <td style={{ padding: '8px', border: '1px solid #d1d5db', backgroundColor: '#f3f4f6', fontWeight: '600' }}>Adresse</td>
                      <td style={{ padding: '8px', border: '1px solid #d1d5db' }}>{data.info.adresse || '-'}</td>
                    </tr>
                  </tbody>
                </table>
                
                {/* PI√àCES */}
                {sortedPieces.map(([key, piece], pieceIndex) => {
                  // Calculer si la pi√®ce est "petite" (peut tenir sur une page)
                  const totalItems = piece.etatLieux.length + piece.inventaire.length;
                  const isSmallSection = totalItems <= 8;
                  
                  return (
                    <div key={key} style={{ marginBottom: '15px' }}>
                      {/* Wrapper pour garder en-t√™te + d√©but du tableau ensemble */}
                      <table style={{ width: '100%', borderCollapse: 'collapse', tableLayout: 'fixed' }}>
                        {/* En-t√™te de pi√®ce DANS le tableau pour qu'il ne soit jamais s√©par√© */}
                        <thead>
                          <tr>
                            <th colSpan="4" style={{ 
                              backgroundColor: '#1e40af', 
                              color: 'white', 
                              padding: '8px 12px', 
                              fontWeight: 'bold', 
                              fontSize: '12px',
                              textTransform: 'uppercase',
                              textAlign: 'left',
                              border: 'none'
                            }}>
                              {piece.nom}
                            </th>
                          </tr>
                          {piece.etatLieux.length > 0 && (
                            <tr style={{ backgroundColor: '#e5e7eb' }}>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'left', fontWeight: '600', width: '40%' }}>√âl√©ment</th>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'center', fontWeight: '600', width: '12%' }}>√âtat</th>
                              <th colSpan="2" style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'left', fontWeight: '600', width: '48%' }}>Commentaire</th>
                            </tr>
                          )}
                        </thead>
                        <tbody>
                          {/* √âtat des lieux */}
                          {piece.etatLieux.map((item, idx) => (
                            <tr key={item.id} style={noBreakInside}>
                              <td style={{ padding: '5px 8px', border: '1px solid #d1d5db', verticalAlign: 'top', width: '40%' }}>{item.nom}</td>
                              <td style={{ padding: '5px 8px', border: '1px solid #d1d5db', textAlign: 'center', verticalAlign: 'top', width: '12%' }}>
                                <span style={{ 
                                  display: 'inline-block',
                                  padding: '2px 8px', 
                                  borderRadius: '4px', 
                                  fontSize: '10px',
                                  fontWeight: '500',
                                  backgroundColor: item.etat === 'Bon' ? '#dcfce7' : item.etat === 'Appropri√©' ? '#fef9c3' : item.etat === 'Mauvais' ? '#fee2e2' : '#f3f4f6',
                                  color: item.etat === 'Bon' ? '#166534' : item.etat === 'Appropri√©' ? '#854d0e' : item.etat === 'Mauvais' ? '#991b1b' : '#6b7280'
                                }}>
                                  {item.etat || '-'}
                                </span>
                              </td>
                              <td colSpan="2" style={{ padding: '5px 8px', border: '1px solid #d1d5db', color: '#4b5563', verticalAlign: 'top', width: '48%' }}>
                                {item.commentaire || '-'}
                                {item.photos.length > 0 && <span style={{ color: '#2563eb', marginLeft: '5px' }}>[üì∑ {item.photos.length}]</span>}
                              </td>
                            </tr>
                          ))}
                          
                          {/* S√©parateur inventaire si besoin */}
                          {piece.etatLieux.length > 0 && piece.inventaire.length > 0 && (
                            <tr style={{ backgroundColor: '#dcfce7', ...noBreakAfter }}>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'left', fontWeight: '600', width: '35%' }}>Inventaire</th>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'center', fontWeight: '600', width: '8%' }}>Qt√©</th>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'center', fontWeight: '600', width: '12%' }}>√âtat</th>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'left', fontWeight: '600', width: '45%' }}>Commentaire</th>
                            </tr>
                          )}
                          
                          {/* Inventaire sans en-t√™te √©tat si pas d'√©tatLieux */}
                          {piece.etatLieux.length === 0 && piece.inventaire.length > 0 && (
                            <tr style={{ backgroundColor: '#dcfce7', ...noBreakAfter }}>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'left', fontWeight: '600', width: '35%' }}>Inventaire</th>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'center', fontWeight: '600', width: '8%' }}>Qt√©</th>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'center', fontWeight: '600', width: '12%' }}>√âtat</th>
                              <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'left', fontWeight: '600', width: '45%' }}>Commentaire</th>
                            </tr>
                          )}
                          
                          {/* Lignes inventaire */}
                          {piece.inventaire.map((item, idx) => (
                            <tr key={item.id} style={noBreakInside}>
                              <td style={{ padding: '5px 8px', border: '1px solid #d1d5db', verticalAlign: 'top' }}>{item.nom}</td>
                              <td style={{ padding: '5px 8px', border: '1px solid #d1d5db', textAlign: 'center', fontWeight: '500', verticalAlign: 'top' }}>{item.qte}</td>
                              <td style={{ padding: '5px 8px', border: '1px solid #d1d5db', textAlign: 'center', verticalAlign: 'top' }}>
                                <span style={{ 
                                  display: 'inline-block',
                                  padding: '2px 8px', 
                                  borderRadius: '4px', 
                                  fontSize: '10px',
                                  fontWeight: '500',
                                  backgroundColor: item.etat === 'Bon' ? '#dcfce7' : item.etat === 'Appropri√©' ? '#fef9c3' : item.etat === 'Mauvais' ? '#fee2e2' : '#f3f4f6',
                                  color: item.etat === 'Bon' ? '#166534' : item.etat === 'Appropri√©' ? '#854d0e' : item.etat === 'Mauvais' ? '#991b1b' : '#6b7280'
                                }}>
                                  {item.etat || '-'}
                                </span>
                              </td>
                              <td style={{ padding: '5px 8px', border: '1px solid #d1d5db', color: '#4b5563', verticalAlign: 'top' }}>{item.commentaire || '-'}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  );
                })}
                
                {/* CL√âS */}
                <div style={{ marginBottom: '15px' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', tableLayout: 'fixed' }}>
                    <thead>
                      <tr>
                        <th colSpan="4" style={{ 
                          backgroundColor: '#eab308', 
                          color: 'white', 
                          padding: '8px 12px', 
                          fontWeight: 'bold', 
                          fontSize: '12px',
                          textTransform: 'uppercase',
                          textAlign: 'left',
                          border: 'none'
                        }}>
                          üîë Cl√©s remises
                        </th>
                      </tr>
                      <tr style={{ backgroundColor: '#e5e7eb' }}>
                        <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'left', fontWeight: '600', width: '35%' }}>Type</th>
                        <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'center', fontWeight: '600', width: '8%' }}>Qt√©</th>
                        <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'center', fontWeight: '600', width: '12%' }}>Rendue</th>
                        <th style={{ padding: '6px 8px', border: '1px solid #d1d5db', textAlign: 'left', fontWeight: '600', width: '45%' }}>Commentaire</th>
                      </tr>
                    </thead>
                    <tbody>
                      {data.cles.map(cle => (
                        <tr key={cle.id} style={noBreakInside}>
                          <td style={{ padding: '5px 8px', border: '1px solid #d1d5db' }}>{cle.nom}</td>
                          <td style={{ padding: '5px 8px', border: '1px solid #d1d5db', textAlign: 'center', fontWeight: '500' }}>{cle.qte}</td>
                          <td style={{ padding: '5px 8px', border: '1px solid #d1d5db', textAlign: 'center' }}>
                            <span style={{ 
                              display: 'inline-block',
                              padding: '2px 8px', 
                              borderRadius: '4px', 
                              fontSize: '10px',
                              fontWeight: '500',
                              backgroundColor: cle.rendue === 'Oui' ? '#dcfce7' : cle.rendue === 'Non' ? '#fee2e2' : '#f3f4f6',
                              color: cle.rendue === 'Oui' ? '#166534' : cle.rendue === 'Non' ? '#991b1b' : '#6b7280'
                            }}>
                              {cle.rendue || '-'}
                            </span>
                          </td>
                          <td style={{ padding: '5px 8px', border: '1px solid #d1d5db', color: '#4b5563' }}>{cle.commentaire || '-'}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                
                {/* SIGNATURES - Toujours ensemble, sur nouvelle page si n√©cessaire */}
                <div className="signatures-block" style={{ ...noBreakInside, marginTop: '30px', paddingTop: '20px', borderTop: '2px solid #d1d5db' }}>
                  <div style={{ display: 'flex', gap: '40px' }}>
                    <div style={{ flex: 1 }}>
                      <p style={{ fontWeight: 'bold', fontSize: '11px', textTransform: 'uppercase', marginBottom: '8px' }}>Signature Locataire</p>
                      <div style={{ 
                        height: '80px', 
                        border: '2px dashed #9ca3af', 
                        borderRadius: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: '#9ca3af',
                        fontSize: '12px',
                        marginBottom: '5px'
                      }}>
                        {data.signatures.locataire || 'Signature'}
                      </div>
                      <p style={{ fontSize: '11px', color: '#4b5563', margin: 0 }}>{data.info.locataire || 'Nom du locataire'}</p>
                      <p style={{ fontSize: '10px', color: '#9ca3af', margin: '3px 0 0 0' }}>Fait √† _____________ le {data.info.date}</p>
                    </div>
                    <div style={{ flex: 1 }}>
                      <p style={{ fontWeight: 'bold', fontSize: '11px', textTransform: 'uppercase', marginBottom: '8px' }}>Signature Propri√©taire</p>
                      <div style={{ 
                        height: '80px', 
                        border: '2px dashed #9ca3af', 
                        borderRadius: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: '#9ca3af',
                        fontSize: '12px',
                        marginBottom: '5px'
                      }}>
                        {data.signatures.proprietaire || 'Signature'}
                      </div>
                      <p style={{ fontSize: '11px', color: '#4b5563', margin: 0 }}>{data.info.proprietaire || 'Nom du propri√©taire'}</p>
                      <p style={{ fontSize: '10px', color: '#9ca3af', margin: '3px 0 0 0' }}>Fait √† _____________ le {data.info.date}</p>
                    </div>
                  </div>
                </div>
                
                {/* PHOTOS - Sur nouvelle page */}
                {allPhotos.length > 0 && (
                  <div style={breakBefore}>
                    <div style={{ 
                      backgroundColor: '#7c3aed', 
                      color: 'white', 
                      padding: '8px 12px', 
                      fontWeight: 'bold', 
                      fontSize: '12px',
                      textTransform: 'uppercase',
                      marginBottom: '15px'
                    }}>
                      üì∑ Annexe photos ({allPhotos.length})
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>
                      {allPhotos.map((p, idx) => (
                        <div key={idx} style={{ ...noBreakInside, border: '1px solid #d1d5db', borderRadius: '8px', overflow: 'hidden' }}>
                          <img src={p.photo.data} alt="" style={{ width: '100%', height: '140px', objectFit: 'cover', display: 'block' }} />
                          <div style={{ padding: '8px', backgroundColor: '#f9fafb', fontSize: '10px' }}>
                            <span style={{ fontWeight: 'bold' }}>Photo {p.index}</span> ‚Äî {p.piece} ‚Äî {p.element}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gray-100 pb-20">
          {showPrint && <PrintView />}
          {selectedPhoto && (
            <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={() => setSelectedPhoto(null)}>
              <button className="absolute top-4 right-4 text-white text-2xl">‚úï</button>
              <img src={selectedPhoto.data} alt="" className="max-w-full max-h-full object-contain rounded-lg" />
            </div>
          )}
          {showConfig && <ConfigModal />}
          {showComparison && <ComparisonModal />}

          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 sticky top-0 z-40 shadow-lg no-print">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-lg font-bold">√âtat des lieux</h1>
                <p className="text-xs opacity-80">{data.info.type === 'entree' ? 'üì• Entr√©e' : 'üì§ Sortie'} ‚Ä¢ {templates[currentTemplate]?.nom}{totalPhotos > 0 && ` ‚Ä¢ üì∑ ${totalPhotos}`}</p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowComparison(true)} className="p-2 bg-white/20 rounded-lg" title="Comparatif">‚öñÔ∏è</button>
                <button onClick={() => setShowConfig(true)} className="p-2 bg-white/20 rounded-lg" title="Config">‚öôÔ∏è</button>
                <button onClick={generatePDF} className="p-2 bg-white/20 rounded-lg" title="PDF">üìÑ</button>
              </div>
            </div>
          </div>

          {/* Content */}
          <div className="p-4">
            {activeTab === 'info' && (
              <>
              <div className="bg-white rounded-xl p-4 shadow-sm">
              <h2 className="font-semibold text-lg mb-4">üìÅ OneDrive (Maintenance)</h2>

  <div className="flex gap-2 mb-3">
    <button
      onClick={refreshOneDriveFolders}
      className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm"
      disabled={odLoading}
    >
      {odLoading ? "..." : "üîÑ Charger les sous-dossiers"}
    </button>

    <button
      onClick={async () => {
        const name = prompt("Nom du nouveau sous-dossier dans Maintenance ?");
        if (!name) return;
        try {
          await createOneDriveFolder(BASE_FOLDER, name);
          await refreshOneDriveFolders();
          setOdSelected(name);
        } catch (e) {
          console.error(e);
          alert("Cr√©ation impossible (nom d√©j√† pris ? droits ?)");
        }
      }}
      className="px-3 py-2 bg-green-600 text-white rounded-lg text-sm"
    >
      ‚ûï Nouveau
    </button>
  </div>

  <label className="block text-sm font-medium mb-2">Sous-dossier (destination)</label>
  <select
    value={odSelected}
    onChange={(e) => setOdSelected(e.target.value)}
    className="w-full p-3 border rounded-lg"
  >
    <option value="" disabled>‚Äî choisir ‚Äî</option>
    {odFolders.map((f) => (
      <option key={f.id} value={f.name}>{f.name}</option>
    ))}
  </select>

  <p className="text-xs text-gray-500 mt-2">
    Chemin : <strong>{BASE_FOLDER}/{odSelected || "‚Ä¶"}/{slug(data.info.adresse || "Adresse")}</strong>
  </p>

  <div className="grid grid-cols-2 gap-2 mt-3">
    <button
      onClick={saveEdlToOneDrive}
      className="py-3 bg-indigo-600 text-white rounded-lg text-sm"
      disabled={odLoading}
    >
      üíæ Sauver OneDrive
    </button>
    <button
      onClick={listEdlsFromOneDrive}
      className="py-3 bg-gray-800 text-white rounded-lg text-sm"
      disabled={odLoading}
    >
      üìÇ Lister EDL
    </button>
  </div>

  {odFiles.length > 0 && (
    <div className="mt-3 space-y-2 max-h-48 overflow-auto">
      {odFiles.map((f) => (
        <div key={f.id} className="flex items-center justify-between bg-gray-50 p-2 rounded-lg border">
          <div className="text-xs">
            <div className="font-medium">{f.name}</div>
            <div className="text-gray-500">{(f.lastModifiedDateTime || "").replace("T", " ").slice(0, 16)}</div>
          </div>
          <button
            onClick={() => loadEdlFromOneDrive(f.name)}
            className="px-3 py-1 bg-blue-600 text-white rounded text-sm"
          >
            Charger
          </button>
        </div>
      ))}
    </div>
  )}
</div>

              <div className="space-y-4">
                {/* Sauvegardes existantes */}
                {savedEdls.length > 0 && (
                  <div className="bg-blue-50 rounded-xl p-4 border border-blue-200">
                    <h3 className="font-medium text-blue-800 mb-2">üìÇ Reprendre un √©tat des lieux</h3>
                    <div className="space-y-2 max-h-40 overflow-auto">
                      {savedEdls.slice().reverse().slice(0, 5).map(edl => (
                        <div key={edl.id} className="flex items-center justify-between bg-white p-2 rounded-lg border">
                          <div className="flex items-center gap-2">
                            <span>{edl.data.info.type === 'entree' ? 'üì•' : 'üì§'}</span>
                            <span className="font-medium text-sm">{edl.label || buildEdlName(edl.data.info)}</span>
                            <span className="text-xs text-gray-400">{edl.data.info.date}</span>
                          </div>
                          <button 
                            onClick={() => loadEdl(edl)} 
                            className="px-3 py-1 bg-blue-600 text-white rounded text-sm"
                          >
                            Charger
                          </button>
                        </div>
                      ))}
                    </div>
                    {savedEdls.length > 5 && (
                      <p className="text-xs text-blue-600 mt-2">+ {savedEdls.length - 5} autres dans l'onglet "Valider"</p>
                    )}
                  </div>
                )}

                <div className="bg-white rounded-xl p-4 shadow-sm">
                  <h2 className="font-semibold text-lg mb-4">Informations</h2>
                  <div className="mb-4">
                    <label className="block text-sm font-medium mb-2">Type</label>
                    <div className="flex gap-2">
                      <button onClick={() => updateInfo('type', 'entree')} className={`flex-1 py-3 rounded-lg font-medium ${data.info.type === 'entree' ? 'bg-green-500 text-white' : 'bg-gray-100'}`}>üì• Entr√©e</button>
                      <button onClick={() => updateInfo('type', 'sortie')} className={`flex-1 py-3 rounded-lg font-medium ${data.info.type === 'sortie' ? 'bg-orange-500 text-white' : 'bg-gray-100'}`}>üì§ Sortie</button>
                    </div>
                  </div>
                  <div className="mb-4">
                    <label className="block text-sm font-medium mb-2">Appartement</label>
                    <div className="flex gap-2">
                      <select value={currentTemplate} onChange={(e) => loadTemplate(e.target.value)} className="flex-1 p-3 border rounded-lg">
                        {Object.entries(templates).map(([key, tpl]) => <option key={key} value={key}>{tpl.nom}</option>)}
                      </select>
                      <button onClick={() => setShowConfig(true)} className="px-4 bg-purple-100 text-purple-700 rounded-lg">‚öôÔ∏è</button>
                    </div>
                  </div>
                  <div className="space-y-3">
                    <div><label className="block text-sm font-medium mb-1">Propri√©taire</label><input type="text" value={data.info.proprietaire} onChange={(e) => updateInfo('proprietaire', e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                    <div><label className="block text-sm font-medium mb-1">Locataire</label><input type="text" value={data.info.locataire} onChange={(e) => updateInfo('locataire', e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                    <div><label className="block text-sm font-medium mb-1">Date</label><input type="date" value={data.info.date} onChange={(e) => updateInfo('date', e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                    <div><label className="block text-sm font-medium mb-1">Adresse</label><textarea value={data.info.adresse} onChange={(e) => updateInfo('adresse', e.target.value)} rows={2} className="w-full p-3 border rounded-lg" /></div>
                  </div>
                </div>
                <button onClick={resetForm} className="w-full py-3 text-red-600 bg-red-50 rounded-lg">R√©initialiser</button>
              </div>
              </>
            )}

            {activeTab === 'pieces' && (
              <div>
                <p className="text-sm text-gray-500 mb-3">Cliquez sur une pi√®ce pour l'inspecter</p>
                {sortedPieces.map(([key, piece]) => <PieceSection key={key} pieceKey={key} piece={piece} />)}
              </div>
            )}

            {activeTab === 'cles' && (
              <div className="bg-white rounded-xl p-4 shadow-sm">
                <h2 className="font-semibold text-lg mb-4">üîë Cl√©s</h2>
                <div className="space-y-4">
                  {data.cles.map(cle => (
                    <div key={cle.id} className="bg-gray-50 p-3 rounded-lg">
                      <div className="flex items-center justify-between mb-2">
                        <span className="font-medium">{cle.nom}</span>
                        <div className="flex items-center gap-2">
                          <span className="text-xs">Qt√©:</span>
                          <input type="number" min="0" value={cle.qte} onChange={(e) => updateCle(cle.id, 'qte', parseInt(e.target.value) || 0)} className="w-12 text-center text-sm p-1 border rounded" />
                        </div>
                      </div>
                      <div className="flex gap-2 mb-2">
                        <span className="text-sm">Rendue:</span>
                        {OUI_NON.map(opt => <button key={opt} onClick={() => updateCle(cle.id, 'rendue', opt)} className={`px-3 py-1 text-sm rounded-lg border ${cle.rendue === opt ? opt === 'Oui' ? 'bg-green-500 text-white' : 'bg-red-500 text-white' : 'bg-white'}`}>{opt}</button>)}
                      </div>
                      <input type="text" placeholder="Commentaire..." defaultValue={cle.commentaire} onBlur={(e) => updateCle(cle.id, 'commentaire', e.target.value)} className="w-full text-sm p-2 border rounded-lg mb-2" />
                      <PhotoGallery photos={cle.photos} onRemove={(photoId) => updateCle(cle.id, 'photos', cle.photos.filter(p => p.id !== photoId))} inputId={`p-c-${cle.id}`} onAddPhoto={(e) => handlePhotoCapture(e, (photos) => updateCle(cle.id, 'photos', photos), cle.photos)} />
                    </div>
                  ))}
                </div>
              </div>
            )}

            {activeTab === 'signature' && (
              <div className="space-y-4">
                <div className="bg-white rounded-xl p-4 shadow-sm">
                  <h2 className="font-semibold text-lg mb-4">Signatures</h2>
                  <div className="space-y-4">
                    <div><label className="block text-sm font-medium mb-2">Locataire</label><input type="text" value={data.signatures.locataire} onChange={(e) => updateSignature('locataire', e.target.value)} placeholder="Nom pour valider" className="w-full p-3 border rounded-lg text-center" /></div>
                    <div><label className="block text-sm font-medium mb-2">Propri√©taire</label><input type="text" value={data.signatures.proprietaire} onChange={(e) => updateSignature('proprietaire', e.target.value)} placeholder="Nom pour valider" className="w-full p-3 border rounded-lg text-center" /></div>
                  </div>
                </div>
                <div className="bg-green-50 rounded-xl p-4">
                  <h3 className="font-medium text-green-800 mb-2">üíæ Sauvegarder</h3>
                  <button onClick={saveCurrentEdl} className="w-full py-3 bg-green-600 text-white rounded-lg font-medium">Sauvegarder cet √©tat des lieux</button>
                  {savedEdls.length > 0 && (
                    <div className="mt-4">
                      <p className="text-sm font-medium text-gray-700 mb-2">üìÇ Mes sauvegardes ({savedEdls.length})</p>
                      <div className="space-y-2 max-h-60 overflow-auto">
                        {savedEdls.slice().reverse().map(edl => (
                          <div key={edl.id} className="bg-white p-3 rounded-lg border shadow-sm">
                            <div className="flex items-center justify-between mb-2">
                              <div>
                                <span className="text-lg mr-2">{edl.data.info.type === 'entree' ? 'üì•' : 'üì§'}</span>
                                <span className="font-medium">{edl.label || buildEdlName(edl.data.info)}</span>
                              </div>
                              <span className="text-xs text-gray-400">{edl.data.info.date}</span>
                            </div>
                            <div className="flex gap-2">
                              <button 
                                onClick={() => loadEdl(edl)} 
                                className="flex-1 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium"
                              >
                                üìÇ Charger
                              </button>
                              <button 
                                onClick={() => deleteEdl(edl.id)} 
                                className="px-3 py-2 bg-red-100 text-red-600 rounded-lg text-sm"
                              >
                                üóë
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
                <div className="bg-blue-50 rounded-xl p-4">
                  <h3 className="font-medium text-blue-800 mb-2">üìã R√©capitulatif</h3>
                  <p className="text-sm text-blue-700">Type: <strong>{data.info.type === 'entree' ? 'Entr√©e' : 'Sortie'}</strong><br />Appartement: <strong>{templates[currentTemplate]?.nom}</strong><br />Photos: <strong>{totalPhotos}</strong></p>
                  <div className="grid grid-cols-2 gap-2 mt-3">
                    <button onClick={() => setShowPrint(true)} className="py-3 bg-blue-600 text-white rounded-lg text-sm">üñ® Aper√ßu</button>
                    <button onClick={generatePDF} disabled={isGeneratingPdf} className="py-3 bg-red-600 text-white rounded-lg text-sm disabled:opacity-50">{isGeneratingPdf ? '...' : 'üìÑ PDF'}</button>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Bottom Navigation */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t flex shadow-lg z-40 no-print">
            <TabButton id="info" icon="FileText" label="Infos" active={activeTab === 'info'} />
            <TabButton id="pieces" icon="Home" label="Pi√®ces" active={activeTab === 'pieces'} badge={totalPhotos} />
            <TabButton id="cles" icon="Key" label="Cl√©s" active={activeTab === 'cles'} />
            <TabButton id="signature" icon="Check" label="Valider" active={activeTab === 'signature'} />
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
